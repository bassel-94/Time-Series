---
title: "Homework"
author: "Bassel MASRI & Andrei CHIRITA"
date: "1/21/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE, warning=FALSE, echo=FALSE}
#https://fred.stlouisfed.org/series/CPIAUCNS
#-- clean environment and load libraries
rm(list=ls())
if(!require(MTS)) install.packages("MTS")
library(ggplot2)
library(tidyverse)
library(zoo)
```

## Exercise 1

The purpose of this exercise is to simulate a path of length $T = 100$ from the VAR(1) model : 

$$
X_t = A_n X_{t-1} + \epsilon_t
$$

Where $\epsilon_t$ is a standard multivariate gaussian white noise.

To demonstrate the parameters of the problem, we will take the simple example of $n=2$, that is a stationary bivariate VAR(1) model which has the following form :

$$
\left(\begin{array}{c} 
X_{1t}\\ 
X_{2t}
\end{array}\right)
= 
\left(\begin{array}{c} 
c_1\\ 
c_2
\end{array}\right)
+
\left(\begin{array}{cc} 
A_{1,1} & A_{1,2}\\ 
A_{2,1} & A_{2,2}
\end{array}\right)
\times
\left(\begin{array}{c} 
X_{1t-1} \\ 
X_{2t-1}
\end{array}\right)
+
\left(\begin{array}{c} 
\epsilon_{1t} \\ 
\epsilon_{2t}
\end{array}\right)
$$ 
In our case, we have the following parameters; $A_{n}(i,i) = \frac{1}{2}$, $A_{n}(i,i+1) = \frac{1}{5}$, and $A_{n}(i,j) = 0$. For the specific case of $n=2$, this enables us to rewrite the model that we need to estimate as follows:

$$
\left(\begin{array}{cc} 
X_{1t}\\ 
X_{2t}
\end{array}\right)
= 
\left(\begin{array}{cc} 
c_1\\ 
c_2
\end{array}\right)
+
\left(\begin{array}{cc} 
0.5 & 0.2\\ 
0 & 0.5
\end{array}\right)
\times
\left(\begin{array}{cc} 
X_{1t-1} \\ 
X_{2t-1}
\end{array}\right)
+
\left(\begin{array}{cc} 
\epsilon_{1t} \\ 
\epsilon_{2t}
\end{array}\right)
$$ 

The steps are :

* Define the parameters of the problem
* Generate VAR(1) model
* Estimate VAR(1) model
* Calculate error on the estimated VAR(1) model.

We will compute the above steps using the following code chunk:

```{r}
#-- define function that simulates var models
simulate_var = function(n, T) {
  
  #-- set seed for reproducible results
  set.seed(123)
  error=rep(0, length(n))
  
  for (l in seq_along(n)){
    p=n[l]
    A=0.5*diag(p)
    X=matrix(0,nrow=p ,ncol=T)
    
    for (i in 1:(p-1)){
      A[i,i+1]=0.2
    }
    
    #-- Generate a VAR model of dimension n[l] with T obs
    for (j in 2:T){
      X[,j]=A%*%X[,(j-1)]+t(t(rnorm(p)))
    }
    
    #-- Estimate a VAR model of dimension n[l] from T obs
    Estim=VAR(t(X),1)
    A_hat=Estim$Phi
    
    #-- Study the estimation error
    B=A_hat-A
    error[l]=sqrt(max(abs(eigen(t(B)%*%B)$values)))
  }
  return(error)
}
```

```{r, warning=FALSE, include=FALSE}
#-- test for T=c(100,200,1000)
n = c(2,5,10,20)
error_T100 = simulate_var(n,100)
error_T500 = simulate_var(n,200)
error_T1000 = simulate_var(n,1000)
```

```{r, include=FALSE, echo = FALSE}
#-- group results in a data frame and produce a column of indices to plot against
df = data.frame("T_100" = error_T100, 
                "T_500" = error_T500, 
                "T_1000" = error_T1000) %>% 
  rowid_to_column() %>%
  gather(key = "T_values", value = "Errors", -rowid)
```

We then compute the error $n=\{2,5,10,20\}$ for the following path lengths; $T=\{100,500,1000\}$ and we get the following plot: 

```{r, echo=FALSE,fig.align='center', fig.width=4, fig.height=3, fig.cap="The variation of error as a function of simulation length T and number of covariates n"}
#-- plot results
ggplot(df, aes(x=rowid, y = Errors, color = T_values)) + 
  geom_line() + geom_point() + theme_bw() + 
  ggtitle("Errors as a function of T and n") + 
  scale_x_discrete(name ="Values of n", limits=c("2","5","10", "20")) +
  theme(plot.title = element_text(size = 10, face = "bold", hjust = 0.6), 
        legend.title = element_text(size = 8, face = "bold"),
        legend.text = element_text(size = 6),
        axis.text=element_text(size=6),
        axis.title=element_text(size=8,face="bold"))
```

Upon examining the plot of the squared $\ell_2$ error term, we notice a consistent increase in the error with respect to the numbers of covariates. When n becomes large, the error value increases. This is expected because the more covariates we have to estimate, the more error we introduce in the model. 

As for the path length $T$, we notice that the smallest error values are for path $T=1000$. This is due to the fact that we have more observations in the time series that enables us to estimate the coefficients more accuratly. To put differently, with more *information* to estimate the model's parameters, we are able to achieve more accurate results.

\newpage

## Exercise 2 

```{r}
data<-read.csv("serie completa.csv",sep=",",header=TRUE)
dates <- seq(ISOdate(1994,4,1), by = "month", length.out = 321)
data$Date<-dates
data<-data[-321,]
CPI<-read.csv("CPIAUCNS.csv",sep=",",header=TRUE)
CPI<-CPI[-321,]
Road_travel<-read.csv("TRFVOLUSM227NFWA.csv")
```
```{r}
CPI1<-data.frame(DATE=CPI[,1],CPI[,2]/CPI[1,2])
CPI1
```
```{r}
data<-data.frame(data,Miles_Travelled=Road_travel[,2])
```
```{r}
data2<-reshape(data, 
        direction = "long",
        varying = list(names(data)[2:5]),
        v.names = "Value",
        idvar = c("Date"),
        timevar = "Type",
        times = c("Diesel","Gasoline","Crude","Miles"))
data2<-data.frame(data2,year=as.numeric(format(as.Date(data2$Date, format="%d/%m/%Y"),"%Y")))
ggplot(data2[data2$Type=="Crude",])+
  aes(x=as.factor(year),y=Value)+
  geom_boxplot()+
  stat_summary(fun=median, geom="smooth", aes(group=1))+
  ggtitle("Yearly Evolution of Crude Oil Prices")+
  xlab("Year")+
  ylab("Price in dolars")
ggplot(data2[data2$Type=="Miles",])+
  aes(x=as.factor(year),y=Value)+
  geom_boxplot()+
  stat_summary(fun=median, geom="smooth", aes(group=1))+
  ggtitle("Yearly Evolution of Miles Travelled per Month")+
  xlab("Year")+
  ylab("Miles")
```

## Adjusting for inflation
```{r}
data3<-data.frame(Date=data$Date,
                 Diesel=data$U.S..No.2.Diesel.Retail.Prices..Dollars.per.Gallon./CPI1[,2],
                 Gasoline=data$U.S..All.Grades.All.Formulations.Retail.Gasoline.Prices..Dollars.per.Gallon./CPI1[,2],
                 Crude=data$Cushing..OK.WTI.Spot.Price.FOB..Dollars.per.Barrel./CPI1[,2],
                 Miles=data$Miles_Travelled)
data3
```
```{r}
data4<-reshape(data3, 
        direction = "long",
        varying = list(names(data3)[2:5]),
        v.names = "Value",
        idvar = c("Date"),
        timevar = "Type",
        times = c("Diesel","Gasoline","Crude","Miles"))
data4<-data.frame(data4,year=as.numeric(format(as.Date(data4$Date, format="%d/%m/%Y"),"%Y")))
ggplot(data4[data4$Type=="Crude",])+
  aes(x=as.factor(year),y=Value)+
  geom_boxplot()+
  stat_summary(fun=median, geom="smooth", aes(group=1))+
  ggtitle("Yearly Evolution of Crude Oil Prices",subtitle = "Adjusted for inflation")+
  xlab("Year")+
  ylab("Price in dolars (1994)")
```
```{r}
par(mfrow=c(1,2))
ggplot(data4[data4$Type=="Diesel"|data4$Type=="Gasoline",])+
  aes(x=Date,y=Value,colour=Type)+
  geom_line()+
  ggtitle("Evolution of Retail Prices of Diesel and Gasoline",subtitle = "Adjusted for inflation")+
  xlab("Year")+
  ylab("Price in dolars (1994)")
ggplot(data4[data4$Type=="Crude",])+
  aes(x=Date,y=Value,colour=Type)+
  geom_line()+
  ggtitle("Crude Oil Prices",subtitle = "Adjusted for inflation")+
  xlab("Year")+
  ylab("Price in dolars (1994)")+
  geom_line(aes(y=rollmean(Value, 12, na.pad=TRUE)),colour="blue")
ggplot(data4[data4$Type=="Miles",])+
  aes(x=Date,y=Value,colour=Type)+
  geom_line()+
  ggtitle("Miles Travelled per Month")+
  xlab("Year")+
  ylab("Miles")+
  geom_line(aes(y=rollmean(Value, 12, na.pad=TRUE)),colour="blue")
```

## Check Seasonality

```{r}
data4<-data.frame(data4,month=as.numeric(format(as.Date(data4$Date, format="%d/%m/%Y"),"%m")))
ggplot(data4[data4$Type=="Crude",])+
  aes(x=as.factor(month),y=Value)+
  geom_boxplot()+
  stat_summary(fun=median, geom="smooth", aes(group=1))+
  ggtitle("Monthly oil prices",subtitle = "Adjusted for inflation")+
  xlab("Month")+
  ylab("Price in dolars (1994)")
ggplot(data4[data4$Type=="Miles",])+
  aes(x=as.factor(month),y=Value)+
  geom_boxplot()+
  stat_summary(fun=median, geom="smooth", aes(group=1))+
  ggtitle("Monthly Miles Travelled")+
  xlab("Month")+
  ylab("Miles Travelled")
```